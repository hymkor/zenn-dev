---
title: "å£ã«å‡ºã›ãªã„ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã®ã²ã¿ã¤ï¼ˆä¸»ã«åå‰ã®ã›ã„ï¼‰"
emoji: "ğŸ’©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["zip","unzip","go","golang"]
published: false
---
### ãã£ã‹ã‘

twitter ã®å…ˆè¡ŒããŒã„ã‚ã„ã‚ä¸å®‰ãªã®ã§è‡ªåˆ†ã®å…¨ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚ã§ã‚‚ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒã‚ã¾ã‚Šã«å·¨å¤§ãªãŸã‚ã€è²§å¼±ãªã†ã¡ã®å›ç·šã§ã¯é€”ä¸­ã§åˆ‡ã‚Œã£ã±ãªã—ã§ã™ã€‚[^å‹•ç”»]
[^å‹•ç”»]:ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒ•ã‚£ãƒ³ã—ãªãŒã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã‚‰ã ã‚ˆã€å¸¸è­˜çš„ã«è€ƒãˆã¦

ãƒ•ã‚¡ã‚¤ãƒ«ãŒå·¨å¤§ã«ãªã‚‹ç†ç”±ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä¸­ã«é™æ­¢ç”»ãƒ»å‹•ç”»ãŒå…¨éƒ¨å…¥ã£ã¦ã„ã‚‹ã›ã„ã§ã™ã€‚ã§ã‚‚ã€ã‚‚ã—ãƒ„ã‚¤ãƒ¼ãƒˆæœ¬ä½“ã® JSON ãŒé™æ­¢ç”»ãƒ»å‹•ç”»ã¨ã„ã£ãŸå·¨å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚ˆã‚Šã‚‚å…ˆã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãªã‚‰ã€åˆ¥ã«å…¨éƒ¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¦ã„ãªãã¨ã‚‚å–ã‚Šå‡ºã›ãã†ãªã‚‚ã®ã§ã™ã€‚

ãƒ†ãƒ¼ãƒ—ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ‰±ã† tar ã¨é•ã„ã€ZIP ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä»»æ„ã®å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤§ã—ã¦è‡ªç”±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ä½¿ã„æ–¹ãŒæƒ³å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ä»˜è¿‘ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹("central directory header")ãŒè¨­ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚†ãˆã«é€”ä¸­ã§åˆ‡ã‚Œã¦ã—ã¾ã†ã¨ã€ã“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå‚ç…§ã§ããªã„ãŸã‚ã€å±•é–‹ã§ããªããªã‚Šã¾ã™ã€‚

ã§ã™ãŒã€ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¯çµæ§‹å …ç‰¢ã§ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãªãã¨ã‚‚ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ³ãƒˆãƒªã®ãƒ˜ãƒƒãƒ€ã‹ã‚‰å¿…è¦æœ€å°é™ã®æƒ…å ±ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚å®Ÿéš› [Info-ZIP] ã§ã‚‚ã€ãã‚Œã‚’åˆ©ç”¨ã—ãŸå¾©å…ƒã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

```
[C:] zip -FF "twitter-2023-01-13-59def7f0fc4962235a2fa30c1cdefa2df9b20da46feba28ae38b2354a12af693 (1).zip" --out New.zip
ã€€ï¼šï¼ˆä¸­ç•¥ï¼‰
 copying: data/tweets_media/1234705029774200832-ESKNGhtVAAEFDsM.jpg  (62733 bytes)
 copying: data/tweets_media/1234844166489661445-ESBEPHyUYAE-Xfi.jpg
zip I/O error: Invalid argument
zip error: Output file write failure (write error on zip file)
exit status 14
```

**ã‚â€¦**

ã“ã‚Œã¯å¤šåˆ†ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å…¨ä½“ã®ã‚µã‚¤ã‚ºãŒ 4GB ã‚’è¶Šãˆã¦ã„ã‚‹ã›ã„ã§ã—ã‚‡ã†ã€‚ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã£ã¦ä¸€å¿œå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã—ã€ã©ã†ã›æ™‚é–“ã¯ã‚ã‚‹ã—ã€ã“ã‚Œã¯ä¸€ã¤ã€è‡ªåˆ†ã§å±•é–‹ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’æ›¸ã„ã¦ã¿ã‚‹ã‹ãªã¨æ€ã„ç«‹ã¡ã¾ã—ãŸã€‚

ï¼ˆãªãŠã€ç€æ‰‹ã—ãŸãã®æ™©ã€å°±å¯å‰ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ãƒªãƒˆãƒ©ã‚¤ã—ãŸçµæœã€ç„¡äº‹å…¨éƒ¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¦ã—ã¾ã£ãŸã®ã¯ç§˜å¯†ã§ã™ã€‚ã ãŒæ„šã‹ãªäººé¡ã¯ãµã‚Šã‚ã’ãŸã“ã¶ã—ã‚’ã•ã’ã‚‰ã‚Œãªã‹ã£ãŸï¼‰

### ã›ã£ã‹ã¡ãªäººã®ãŸã‚ã«ã€ã„ããªã‚Šæˆæœç‰©

æœ«å°¾ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ¬ ã‘ãŸ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã§ã‚‚ä¸­èº«ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ã™ã‚‹ãƒ„ãƒ¼ãƒ« [uncozip] ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

- [Releases Â· hymkor/uncozip](https://github.com/hymkor/uncozip/releases)

ã‚ˆã‚Šæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ scoop ãŒä½¿ãˆã‚‹äººã¯

```
scoop install https://raw.githubusercontent.com/hymkor/uncozip/master/uncozip.json
```

ã‚‚ã—ãã¯

```
scoop bucket add hymkor https://github.com/hymkor/scoop-bucket
scoop install uncozip
```

ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ã§ã™ã€‚`uncozip ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«å` ã§ã©ã†ã

### åŸºæœ¬åŸç†

ã€ŒZIP ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã§ã‚°ã‚°ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªãƒšãƒ¼ã‚¸ãŒãƒ’ãƒƒãƒˆã—ã¾ã™ã€‚

- [ZIP (ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ) - Wikipedia](https://ja.wikipedia.org/wiki/ZIP_(%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88))
- [ZIPæ›¸åº«ãƒ•ã‚¡ã‚¤ãƒ« ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ - ç•¥ã—ã¦ä»®ã€‚](http://menyukko.ifdef.jp/cauldron/dtzipformat.html)
- [ZIPã®ä»•æ§˜ã‚’æ—¥æœ¬èªã§ã¾ã¨ã‚ã‚‹](https://gist.github.com/ysakasin/2edf8d3bf55c6ebf63f82851e302b030)
- [APPNOTE.TXT 6.3.10](https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT)

ã‚‚ã†ãŠè…¹ã„ã£ã±ã„ã§ã™ã€ååˆ†ã™ãã¾ã™ã€‚ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ ã¯ãŠãŠã‚ˆãæ¬¡ã®ã‚ˆã†ãªå½¢ã«ãªã‚Šã¾ã™ã€‚

| |  |
|--|--|
| 1ãƒ•ã‚¡ã‚¤ãƒ«ç›® | "local file header" (å›ºå®šé•·)
| | ãƒ•ã‚¡ã‚¤ãƒ«å (å¯å¤‰é•·:é•·ã•ã¯ "local file header" å†…ã«è¨˜è¼‰)
| | æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (å¯å¤‰é•·:é•·ã•ã¯ "local file header" å†…ã«è¨˜è¼‰)
| | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿æœ¬ä½“ (å¯å¤‰é•·:é•·ã•ã¯ä¸æ˜ãªå ´åˆãŒã‚ã‚‹)
| | "data descriptor" (ãªã„æ™‚ãŒã‚ã‚‹/2ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹)
| 2ãƒ•ã‚¡ã‚¤ãƒ«ç›® | ä»¥ä¸‹ç¹°ã‚Šè¿”ã—
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ |ï¼ˆ"central directory header"ï¼‰
| | ä»Šå›ã¯å‚ç…§ã—ãªã„ã®ã§çœç•¥

ã“ã‚Œã‚‰ã«å¾“ã†ã¨ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ã™ã‚‹ã«ã¯

1. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ï¼ˆlocal file headerï¼‰ã‚’ ["encoding/binary"] ã® Read é–¢æ•°ã§èª­ã‚€
2. ç›´å¾Œã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ io.ReadFull ã§èª­ã‚€
    - ãƒ•ã‚¡ã‚¤ãƒ«åã®é•·ã•ã¯ãƒ˜ãƒƒãƒ€ã«æ˜è¨˜ã•ã‚Œã¦ã„ã‚‹
    - ãƒ•ã‚¡ã‚¤ãƒ«åã¯åŸºæœ¬å‹•ä½œç’°å¢ƒãŒå®šã‚ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ãŒã€UTF8 ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã¨ãã¯ãƒ˜ãƒƒãƒ€å†…ã® UTF8 ãƒ“ãƒƒãƒˆãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹
3. æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚µã‚¤ã‚ºãŒï¼‘ä»¥ä¸Šã®æ™‚ã¯ã€ãã®æ•°åˆ†ã®ãƒã‚¤ãƒˆæ•°ã‚’èª­ã¿é£›ã°ã™
    - å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒ4GBã‚’è¶Šãˆã¦ã„ã‚‹å ´åˆã¯ã“ã“ã« ZIP64 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ã¡ã‚ƒã‚“ã¨å‚ç…§ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ãŒã€å¹¸ã„ã€twitter ã® ZIP ã¯ãã†ã§ã¯ãªã‹ã£ãŸã®ã§ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ä½œæˆã§ã¯å¯¾å¿œã›ãšã«æ¸ˆã‚“ã ï¼ˆæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯å¯¾å¿œæ¸ˆã¿ï¼‰
4. ã“ã®å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’èª­ã¿ã ã—ã¦ã€["compress/flate"] ã§ä¼¸é•·ã™ã‚‹

ã®ç¹°ã‚Šè¿”ã—ã§è‰¯ã•ãã†ã§ã™ã€‚å®Ÿéš›ã€ãƒ†ã‚¹ãƒˆç”¨ã«ä½œã£ãŸã‚·ãƒ³ãƒ—ãƒ«ãª ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚Œã°ã€OK ã§ã—ãŸã€‚

### åœ§ç¸®æ™‚ã«ã‚µã‚¤ã‚ºãŒæœªå®šã®ãƒ•ã‚¡ã‚¤ãƒ«

ã¨ã“ã‚ãŒ twitter ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€"local file header"ã«è¨˜è¼‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒã‚¼ãƒ­ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ä¸å…·åˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŠãã‚‰ãã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ãªãŒã‚‰ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã«è½ã¨ã•ãšã€ç›´æ¥ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«æ ¼ç´ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ãŸã€ZIPã®ä»•æ§˜ãªã®ã§ã—ã‚‡ã†ã€‚ã“ã®å ´åˆã€æ¬¡ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚

- "local file header"ã®åœ§ç¸®å‰ã‚µã‚¤ã‚º åœ§ç¸®å¾Œã‚µã‚¤ã‚ºãƒ»CRC32(ãƒã‚§ãƒƒã‚¯ã‚µãƒ )ãŒã‚¼ãƒ­ã«ãªã‚‹
- "local file header"å†…ã®æ±ç”¨ãƒ•ãƒ©ã‚°ãƒ“ãƒƒãƒˆã®ç¬¬3ãƒ“ãƒƒãƒˆ(=0x0008)ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹
- ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã®å¾Œã® "data descriptor" ã¨ã„ã†é ˜åŸŸãŒè¿½åŠ ã•ã‚Œã€ã“ã“ã«æœ€çµ‚çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ»CRC32 ãŒæ ¼ç´ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹

ã“ã‚Œã‚’è¦‹ã‚‹é™ã‚Šã¯ DataDescritor ã®ãƒãƒ¼ã‚¯ï¼ˆæ­£ã—ãã¯ Signature:`"PK\0x07\x08"`ï¼‰ã‚’æ¤œç´¢ã™ã‚Œã°ã‚ˆã•ãã†ã§ã™â€¦

#### Data descriptor
| ã‚ªãƒ•ã‚»ãƒƒãƒˆ | ã‚µã‚¤ã‚º | å†…å®¹ 
|-----------|--------|-----
| 0	| 0/4 | ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰ã‚·ã‚°ãƒãƒãƒ£=`"PK\0x07\x08"`
| 0/4 |	4 | CRC-32
| 4/8 | 4 | åœ§ç¸®ã‚µã‚¤ã‚º
| 8/12 | 4 | éåœ§ç¸®ã‚µã‚¤ã‚º

**ï¼ã€€ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã€€ï¼œ**

**ã‚ã‹ã‚“ã‚„ã‚“**

"data descriptor" ã®æ¤œå‡ºãŒã‚ã¦ã«ãªã‚‰ãªã„ã®ã§ã‚ã‚Œã°ã€æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®"local file header"ã‚’ãã®ãƒãƒ¼ã‚¯ï¼ˆ`"PK\x03\x04"`ï¼‰ã‹ã‚‰æ¤œç´¢ã—ã¦ã€ãã“ã‹ã‚‰é¡ã‚‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚ã•ã‚‰ã«å£Šã‚Œã¦ã„ãªã„ ZIP ã‚‚æ‰±ã†å ´åˆã¯æ¬¡ã«æ¥ã‚‹ã®ã¯"local file header"ã§ã¯ãªãã‚»ãƒ³ãƒˆãƒ©ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒãƒ¼ã‚¯ï¼ˆ`"PK\x01\x02"`ï¼‰ãŒæ¥ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

**ãˆã‡ã€ã‚„ã‚Šã¾ã—ãŸã¨ã‚‚ã€ãˆã‡ï¼**

`"PK\x03\x04"` ã‚’æ¤œç´¢ã—ã¦ã€ãã“ã‹ã‚‰ "data descriptor" åˆ†ã‚’ã‚«ãƒƒãƒˆã™ã‚Œã°ã€ãã‚ŒãŒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿æœ¬ä½“ã§ã™ã€‚ ãƒ‡ãƒ¼ã‚¿ã®ä¸­ã« `"PK\003\x04"`ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ãªã‚“ã¦æ»…å¤šã«ãªã„ã§ã—ã‚‡ã†ã‹ã‚‰ã€ã“ã‚Œã§å¤§ä¸ˆå¤«ã§ã—ã‚‡ã†ï¼ˆãƒ•ãƒ©ã‚°ï¼‰

ã“ã®ã‚ãŸã‚Šã¾ã§ã‚’å®Ÿè£…ã—ãŸã®ãŒã€ŒãŸã¶ã‚“å‹•ãã¨æ€ã†ã‚ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³()ã€ã§ã‚ã‚‹ã¨ã“ã‚ã® [uncozip v0.0.1](https://github.com/hymkor/uncozip/releases/tag/v0.0.1)ã§ã™ã€‚ã“ã“ã¾ã§ä¸€å¿œå½“åˆã®ç›®çš„ã®ã€Œtwitter ã® ZIP ã®å±•é–‹ã€ã¨ã„ã†ç›®çš„ã¯é”æˆã§ãã¾ã—ãŸã€‚

### å¤§ä¸ˆå¤«ã˜ã‚ƒãªã‹ã£ãŸï¼ˆãƒ•ãƒ©ã‚°æ¶ˆåŒ–ï¼‰

æ»…å¤šã©ã“ã‚ã‹é »ç¹ã«ã‚ã‚Šã¾ã—ãŸã€‚ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã« ZIP ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã§ã™ã€‚ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã‚Œä»¥ä¸Šã®åœ§ç¸®ã¯æœŸå¾…ã§ããªã„ã“ã¨ã‹ã‚‰ã€ã“ã‚Œã‚’ã•ã‚‰ã« ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«æ ¼ç´ã™ã‚‹å ´åˆã€ç„¡åœ§ç¸®ã«ãªã‚Šã¾ã™ã€‚ã™ã‚‹ã¨å­ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¦ªZIPã®ãƒãƒ¼ã‚«ãƒ¼ã¨æ··åŒã—ã¦ã—ã¾ã†ã®ã§ã™ã€‚

ã“ã®èª¤èªè­˜ã‚’åˆ¤å®šã™ã‚‹ã«ã¯ã€ã‚‚ã†æ•´åˆæ€§ã®æ­£ã—ã•ã‚’ç¢ºèªã™ã‚‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚å…·ä½“çš„ã«ã¯ã€ã“ã®ãƒãƒ¼ã‚«ãƒ¼ãŒæ­£ã—ã„ã¨éç¨‹ã—ãŸå ´åˆã«æŠ½å‡ºã§ãã‚‹ "data descriptor" ã®åœ§ç¸®å¾Œãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã®ã‚µã‚¤ã‚ºã€ã‚‚ã—ãã¯ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã®ã‚µã‚¤ã‚ºï¼ï¼”ãƒã‚¤ãƒˆã§ã‚ã‚‹ã¯ãšã§ã™ã€‚ã“ã®åˆ¤å®šå‡¦ç†ã‚’ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã®ä¸­ã«å…¥ã‚Œã¦ã¿ãŸã¨ã“ã‚ã€æœŸå¾…ã©ãŠã‚Šå±•é–‹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚[^è¶£å‘³]

[^è¶£å‘³]:ãŸã ã€è‡ªåˆ†ã®è¶£å‘³ã§æ¨™æº–å…¥åŠ›ã«å¯¾å¿œã—ãŸã‹ã£ãŸãŸã‚ã€[io.Reader] ã—ã°ã‚Šã¨ãªã‚Šã€ãªã‹ãªã‹ãŸã„ã¸ã‚“ã§ã—ãŸã€‚

### æœ¬å½“ã«å¤§ä¸ˆå¤«ã§ã—ã‚‡ã†ã‹ï¼Ÿ

å±•é–‹ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›®è¦–ã§è¦‹ã‚‹é™ã‚Šã¯å¤§ä¸ˆå¤«ãã†ã§ã™ã€‚ã§ã‚‚ã€ã¡ã‚ƒã‚“ã¨ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã§ç¢ºèªã—ã¦ãŠãã¹ãã§ã™ã€‚
["compress/flate"] ã§ä¼¸é•·ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«å‡ºåŠ›ã™ã‚‹ã®ã¨åŒæ™‚ã«ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’ã¨ã‚Šã¾ã—ã‚‡ã†ã€‚

ä¼¸é•·å‡¦ç†ã¯ ["compress/flate"] ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ `flate.NewReader(ä¼¸é•·å‰ã®ãƒ‡ãƒ¼ã‚¿ã®io.Reader)` ã§ OK ã§ã™ã€‚æˆ»ã‚Šå€¤ãŒä¼¸é•·å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾—ã‚‹ [io.ReadCloser] ã«ãªã£ã¦ã„ã¾ã™(ã¤ã¾ã‚Šè¦CloseãªReader)ã€‚ã“ã‚Œã§èª­ã¿ã ã—ãŸå€¤ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«ã‚»ãƒ¼ãƒ–ã™ã‚‹ã«ã¯ [io.Copy] ã§å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚Œã°ã‚ˆã„ã®ã§ã™ãŒã€ã“ã‚Œã‚’ [io.TeeReader] ã§æ¨ªå–ã‚Šã—ã¾ã—ã‚‡ã†ã€‚

```go
rc := flate.NewReader(b) // b ã¯å‰ç¯€ã§åˆ‡ã‚Šå‡ºã—ãŸ "data descriptor" ç›´å‰ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ io.Reader
fd, err := os.Create(fname)
h := crc32.NewIEEE()
_, err = io.Copy(fd, io.TeeReader(rc, h))
crc32 = h.Sum32()
```

ã“ã‚Œã‚’"local file header"ã€ã‚‚ã—ãã¯ "data descriptor" ã«è¨˜è¼‰ã® CRC32 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨æ¯”è¼ƒã™ã‚‹ã ã‘ã§ã™ã€‚ã­ã€ç°¡å˜ã§ã—ã‚‡ï¼Ÿ

### ZIP64å¯¾å¿œ

ã“ã®ã‚ãŸã‚Šã¾ã§å®Ÿè£…ã—ãŸã®ãŒ [v0.1.0](https://github.com/hymkor/uncozip/releases/tag/v0.1.0)ã¨ãªã‚Šã¾ã™ã€‚ ã‚ã¨ã«æ®‹ã•ã‚ŒãŸä»•æ§˜ã¯

- ZIP64å¯¾å¿œ
- æš—å·åŒ–ZIP

ã¨ã„ã£ãŸã¨ã“ã‚ã§ã™ã€‚ã“ã‚Œã‚‰ã¯å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã€Œå£Šã‚ŒãŸZIPã§ã‚‚å±•é–‹ã§ãã‚‹ã€ã¨ã„ã†è§¦ã‚Œè¾¼ã¿ã§ã‚ã‚Œã°ã€ä¸€å¿œã€Œã‚¿ã‚¤ãƒˆãƒ«ã«å½ã‚Šãªã—ã€ã®ãŸã‚ã«ã‚‚å®Ÿè£…ã—ã¦ãŠããŸã„ã¨ã“ã‚ã§ã™ã€‚

ZIP64 å¯¾å¿œã®æ–¹ã¯ç°¡å˜ã§ã—ãŸã€‚æ‹¡å¼µãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯

|  |  |
|--|--|
| 2ãƒã‚¤ãƒˆ | ID |
| 2ãƒã‚¤ãƒˆ | ã‚µã‚¤ã‚º(n) |
| nãƒã‚¤ãƒˆ | ãƒ‡ãƒ¼ã‚¿æœ¬ä½“ |

ã®ç¹°ã‚Šè¿”ã—ã«ãªã£ã¦ã„ã¦ã€ID=1 ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒZIP64ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã™ã€‚ ZIP64 ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿æœ¬ä½“ã®æœ€åˆã®8ãƒã‚¤ãƒˆãŒåœ§ç¸®å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã€æ¬¡ã®8ãƒã‚¤ãƒˆã«åœ§ç¸®å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãŒä¸¦ã‚“ã§ã„ã¾ã™[^è©³ã—ãã¯]ã€‚
[^è©³ã—ãã¯]: ãã‚Œæ„å¤–ã®ãƒ‡ãƒ¼ã‚¿ã¯ "local file header" ã§å‚ç…§ã™ã‚‹å ´åˆã¯ã€æ­£ç›´ã©ã†ã§ã‚‚ã‚ˆã„ã®ã§ã€è©³ã—ãã¯ http://menyukko.ifdef.jp/cauldron/dtzipformat.html#academy

### æš—å·åŒ–å¯¾å¿œ

ZIPã¯ä¸€å¿œè¤‡æ•°ã®æš—å·åŒ–ã®å®Ÿè£…ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ãŒã€å®Ÿè³ªã€ŒTraditional PKWARE Encryptionã€ã ã‘ã«å¯¾å¿œã—ã¦ã„ã‚Œã°ã‚ˆã•ãã†ã§ã™ã€‚ã“ã“ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯æ­£ç›´ã‚ˆãåˆ†ã‹ã‚‰ãªã£ãŸã®ã§

- [ä»•æ§˜æ›¸]ã®ã€Œ6.1 Traditional PKWARE Decryptionã€ã«è¨˜è¼‰ã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰
- ãŠæ‰‹æœ¬ã¨ã—ãŸå‡¦ç†ç³»ï¼šhttps://github.com/kdungs/zip ã® [zipcrypto.go](https://github.com/kdungs/zip/blob/master/zipcrypto.go)

ã®æ›¸ãæ–¹ã‚’ã»ã¨ã‚“ã©çœŸä¼¼ã•ã›ã¦ã„ãŸã ãå½¢ã«ãªã‚Šã¾ã—ãŸã€‚æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã¯

|  |  |
|--|--|
| æœ€åˆã®12ãƒã‚¤ãƒˆ | æš—å·åŒ–ãƒ˜ãƒƒãƒ€
| 13ãƒã‚¤ãƒˆç›®ä»¥é™ | ãƒ‡ãƒ¼ã‚¿æœ¬ä½“

ã¨ã„ã†æ§‹é€ ã«ãªã£ã¦ã„ã¾ã™ã€‚å¾©å·åŒ–å‡¦ç†è‡ªä½“ã¯1ãƒã‚¤ãƒˆç›®ã‹ã‚‰å…¨éƒ¨ã‚„ã‚‹ã‘ã‚Œã©ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ã†å ´æ‰€ã¯13ãƒã‚¤ãƒˆç›®ä»¥é™ã§ã€1ï½12ãƒã‚¤ãƒˆã®ã¨ã“ã‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®æ¤œè¨¼ã«ä½¿ã†ã ã‘ã¨ã„ã†æ„Ÿã˜ã®ã‚ˆã†ã§ã™ã€‚

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã£ã¦ã„ã‚‹ã‹ã®æ¤œè¨¼ã§ã™ãŒã€ã‚„ã‚‰ãªãã¦ã‚‚ã€å¾©å·åŒ–ã—ãŸçµæœãŒ deflate å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦é–“é•ã£ã¦ã„ã‚‹ã“ã¨è‡ªä½“ã¯åˆ†ã‹ã‚‹ã®ã§ã™ãŒã€ãã†ã™ã‚‹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ã—ãªãŠã™ãŸã‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒé¢å€’ãªã®ã§ã€æ—©ã„ã†ã¡ã«ã‚„ã‚Šç›´ã—ãŸæ–¹ãŒã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚

ã§ã€ã‚ˆãåˆ†ã‹ã‚‰ãªã‹ã£ãŸã®ãŒã€è‚å¿ƒã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ¤œè¨¼æ–¹æ³•ã€‚[ä»•æ§˜æ›¸]ã§ã¯

>   After the header is decrypted,  the last 1 or 2 bytes in Buffer SHOULD be the high-order word/byte of the CRC for the file being decrypted, stored in Intel low-byte/high-byte order.  Versions of PKZIP prior to 2.0 used a 2 byte CRC check; a 1 byte CRC check is used on versions after 2.0.  This can be used to test if the password supplied is correct or not.

ã¨ã‚ã‚Šã€è¦ã¯12ãƒã‚¤ãƒˆã‚’å¾©å·åŒ–ã—ãŸæ™‚ã®æœ€å¾Œã®1ï½2ãƒã‚¤ãƒˆéƒ¨åˆ†ãŒ CRC ã¨æ¯”è¼ƒã™ã‚‹â€¦ã¨ã‚ã‚Šã¾ã™ã€‚ ã“ã®ã€ŒCRCã€ã¯ "local file header" ã® CRC32 ã®ã“ã¨ã ã‚ã†ãªã¨æ€ã£ãŸã®ã§ã™ãŒâ€¦ ã©ã†ã—ã¦ã‚‚ä¸€è‡´ã—ã¾ã›ã‚“ã€‚

ä»•æ–¹ãŒãªã„ã®ã§ã€ãŠæ‰‹æœ¬ã®å‡¦ç†ç³» [kdungs/zip] ã‚’è¦‹ãŸã¨ã“ã‚

- å¾©å·åŒ–éƒ¨åˆ†ã§ã¯ãƒãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆã„ã„ã®ã‹ã€ãã‚Œâ€¦ï¼‰
- æš—å·åŒ–éƒ¨åˆ†ã§ã¯ CRC32 ã§ã¯ãªãã€æœ€çµ‚æ›´æ–°æ™‚åˆ»ã® unsigned short è¡¨ç¾ã‚’ CRC ã¨ã—ã¦ä½¿ã£ã¦ã„ã‚‹  
  â†’ https://github.com/kdungs/zip/blob/master/zipcrypto.go#L93

**ã¾ã˜ã‹â€¦** é¨™ã•ã‚ŒãŸã¨æ€ã£ã¦ã€[uncozip] ã®å¾©å·åŒ–éƒ¨åˆ†ã§ã€æœ€çµ‚æ›´æ–°æ™‚åˆ»ã¨æ¯”è¼ƒã•ã›ã‚‹ã‚ˆã†ã«ã—ãŸã‚‰

- Info-ZIP ã§ä½œæˆã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãZIPãƒ•ã‚¡ã‚¤ãƒ«ã«å¤§ã—ã¦ã€æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§é–‹å°ã—ã‚ˆã†ã¨ã—ãŸæ™‚  
  â†’ æœ€çµ‚æ›´æ–°æ™‚åˆ»ã® unsigned short è¡¨ç¾ã¨ä¸€è‡´ã™ã‚‹ : OK
- Info-ZIP ã§ä½œæˆã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãZIPãƒ•ã‚¡ã‚¤ãƒ«ã«å¤§ã—ã¦ã€èª¤ã£ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§é–‹å°ã—ã‚ˆã†ã¨ã—ãŸæ™‚  
  â†’ æœ€çµ‚æ›´æ–°æ™‚åˆ»ã® unsigned short è¡¨ç¾ã¨ä¸€è‡´ã—ãªã„ : OK

**ã†ã¾ãå‹•ãã˜ã‚ƒã‚“**

ã„ã£ãŸã„ã©ã†ã„ã†ã“ã¨ãªã‚“ã§ã—ã‚‡ã†ã­ã‡ã€‚ä»•æ§˜æ›¸ãŒãŠã‹ã—ã„ã®ã‹ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚å¤‰ã‚ã£ãŸã®ã‹â€¦

["compress/flate"]:https://pkg.go.dev/compress/flate
["encoding/binary"]:https://pkg.go.dev/encoding/binary
[Info-Zip]:https://ja.wikipedia.org/wiki/Info-ZIP
[flate.NewReader]:https://pkg.go.dev/compress/flate#NewReader
[io.Copy]:https://pkg.go.dev/io#Copy
[io.ReadCloser]:https://pkg.go.dev/io#ReadCloser
[io.Reader]:https://pkg.go.dev/io#Reader
[io.TeeReader]:https://pkg.go.dev/io#TeeReader
[uncozip]:https://github.com/hymkor/uncozip
[ä»•æ§˜æ›¸]:https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT
[kdungs/zip]:https://github.com/kdungs/zip